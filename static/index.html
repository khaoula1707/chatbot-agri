<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>مساعد الفلاح</title>
  <link rel="icon" type="image/png" href="static/image/favicon.png"/>
  <style>
    :root {
  --bg: #f5f7f3;         
  --chat-bg: #ffffff;       
  --user-msg: #d4f4c2;  
  --bot-msg: #e8fbe5;        
  --text: #1f1f1f;          
  --header: #4d7c0f; 
  --mic-bg: #4d7c0f;
  --mic-hover: #4d7c0f; 
  --send-bg: #4d7c0f;
  --send-hover: #4d7c0f;
  --send-text: #ffffff;       
 }


  body.dark {
  --bg: #0d0f0c;            
  --chat-bg: #1a1d18;     
  --user-msg: #17401a;      
  --bot-msg: #1f4a20;     
  --text: #e5ffe5;          
  --header: #133c12;  
  --mic-bg: #133c12;
  --mic-hover: #133c12;  
  --send-bg: #133c12;
  --send-hover: #133c12;
  --send-text: #ffffff;   
  }


    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background-color: var(--header);
      color: white;
      padding: 16px 24px;
      font-size: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .buttons {
      display: flex;
      gap: 8px;
    }

    .top-actions {
  width: 100%;
  max-width: 900px;
  display: flex;
  justify-content: flex-start;
  margin-bottom: 8px;
  padding: 0 10px;
}


.reset-btn-floating {
  position: absolute;
  top: 100px;
  left: 280px;
  background-color: var(--header);
  border: none;
  border-radius: 50%;
  width: 38px;
  height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  z-index: 100;
  transition: background-color 0.3s ease;
}

.reset-btn-floating:hover {
  filter: brightness(1.1);
}



    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      overflow: hidden;
    }

    .chatbox {
      width: 100%;
      max-width: 900px;
      flex-grow: 1;
      background: var(--chat-bg);
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-start;
      position: relative; 
 }

    
    .message {
      padding: 12px 18px;
      border-radius: 18px;
      line-height: 1.6;
      white-space: pre-wrap;
      direction: rtl;
      display: inline-block; 
      max-height: auto; 
      max-width: 100%; 
      width: fit-content;
    }

    .user {
      background-color: var(--user-msg);
      align-self: flex-end;
      text-align: right;
    }

    .bot {
      background-color: var(--bot-msg);
      align-self: flex-start;
      text-align: right;
    }

    .typing-indicator {
      font-size: 15px;
      color: #999;
      padding: 8px;
    }

    .input-box {
      position: sticky;
      bottom: 0;
      background-color: var(--bg);
      width: 100%;
      max-width: 900px;
      display: flex;
      gap: 10px;
      padding: 10px;
      z-index: 10;
    }

    input {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #ccc;
      font-size: 16px;
      outline: none;
    }

    body.dark input {
      background-color: #2a2a2a;
      color: white;
      border: 1px solid #444;
    }

    .toggle-btn {
  background-color: var(--header); 
  color: white; 
  border: none;
  border-radius: 5px;
  padding: 8px;
  cursor: pointer;
  font-size: 16px;
  transition: background-color 0.3s;
}


.toggle-btn:hover {
  filter: brightness(1.1); 
}

/*question par défault */
.suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0;
    }
.suggestions button {
  background-color: #f8f8f8;
  color: #292929;
  padding: 8px 14px;
  font-size: 15px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  transition: background-color 0.3s;
}

.suggestions button:hover {
  background-color: #dddddd;
}


body.dark .suggestions button {
  background-color: #333333;
  color: #f1f1f1;
}

body.dark .suggestions button:hover {
  background-color: #444444;
}

/*micro */
.mic-btn {
  background-color: var(--mic-bg);
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color 0.3s;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
  color: white;
}

.mic-btn:hover {
  background-color: var(--mic-hover);
  transform: scale(1.1);
}

.mic-btn svg {
  width: 24px;
  height: 24px;
  fill: white;
}



    .footer-note {
      text-align: center;
      font-size: 12px;
      color: #777;
      padding: 10px;
    }
 
    #sendBtn {
  background-color: var(--send-bg);
  color: var(--send-text);
  border: none;
  border-radius: 12px;
  padding: 10px 20px;
  font-size: 16px;
  font-weight: normal;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.2s;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  gap: 8px;
  direction: rtl;
}

#sendBtn:hover {
  background-color: var(--send-hover);
  transform: scale(1.03);
}

    .scroll-down-btn {
      position: fixed;
      bottom: 85px;
      right: 20px;
      background-color: #205072;
      color: white;
      border: none;
      border-radius: 30px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      display: none;
      z-index: 99;
    }
    @media (max-width: 600px) {
      .chatbox, .input-box {
        max-width: 100%;
        border-radius: 0;
        padding: 10px;
      }

      input {
        font-size: 14px;
      }

      button {
        font-size: 14px;
        padding: 10px 14px;
      }
    }

    .message.user {
  position: relative;
}

.edit-btn {
  position: absolute;
  top: 8px;
  left: 8px;
  background: transparent;
  border: none;
  font-size: 16px;
  cursor: pointer;
  display: none;
  color: #666;
}

.message.user:hover .edit-btn {
  display: inline-block;
}

body.dark .edit-btn {
  color: #bbb;
}

.edit-btn:hover {
  color: #000;
}

body.dark .edit-btn:hover {
  color: #fff;
}





  </style>
</head>
<body>
  <header>
    <span>مساعد الفلاح</span>
    <div class="buttons">
      <button class="toggle-btn" onclick="toggleDarkMode()">🌙</button>
    </div>
  </header>

  <div class="main">
    
    <button class="reset-btn-floating" onclick="resetConversation()" title="إعادة المحادثة">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" fill="white" viewBox="0 0 24 24">
        <path d="M12 6V3L8 7l4 4V8c2.76 0 5 2.24 5 5a5 5 0 0 1-5 5 5 5 0 0 1-4.9-4h-2.02c.47 3.39 3.39 6 6.92 6 3.87 0 7-3.13 7-7s-3.13-7-7-7z"/>
      </svg>
    </button>
    
    <div class="chatbox" id="chatbox">
    
    </div>
    
    
    
    <div class="suggestions" id="suggestions">
      <button onclick="handleSuggestionClick(this)">ما هي الوثائق المطلوبة لحفر بئر؟</button>
      <button onclick="handleSuggestionClick(this)">ما هي إجراءات تأسيس تعاونية فلاحية؟</button>
      <button onclick="handleSuggestionClick(this)">ما هي أنواع الدعم الفلاحي المتاحة؟</button>
    </div>
    
   

    <div class="typing-indicator" id="typing" style="display: none;">🕐 جاري إعداد الإجابة...</div>
     
    <div class="input-box">
      <input type="text" id="userInput" placeholder="اكتب سؤالك هنا..." />
      <button id="micBtn" class="mic-btn" onclick="startSpeech()" aria-label="Microphone">
        <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3Zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2Zm-4 6.92V21h-2v-3.08A8.001 8.001 0 0 1 4 11H2a10 10 0 0 0 20 0h-2a8.001 8.001 0 0 1-9 6.92Z"/>
        </svg>
      </button>
         
      <button id="sendBtn" onclick="handleSendOrStop()">
       
        <svg class="send-icon" width="20" height="20" viewBox="0 0 24 24" fill="white" style="transform: rotate(180deg);" xmlns="http://www.w3.org/2000/svg">
          <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
        </svg>
      </button>
      
      
      
    </div>
  </div>

  

  <div class="footer-note">
     قد يُصدر مساعد الفلاح إجابات غير دقيقة أحيانًا. يُفضل دائمًا التحقق من المعلومات الرسمية قبل اتخاذ أي قرار.
  </div>
  

  <script>
    const chatbox = document.getElementById("chatbox");
    const input = document.getElementById("userInput");
    const typing = document.getElementById("typing");
    let isBotTyping = false;

    function editMessage(icon) {
  const messageText = icon.parentElement.querySelector(".msg-text").textContent;
  input.value = messageText;
  icon.parentElement.remove(); // Supprimer l’ancien message
}

function handleSendOrStop() {
  if (isBotTyping) {
    stopTyping();
  } else {
    sendMessage();
  }
}

function updateSendButton(state) {
  const btn = document.getElementById("sendBtn");
  if (state === "stop") {
    // أيقونة الإيقاف المؤقت ⏸️
    btn.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="black" xmlns="http://www.w3.org/2000/svg">
        <rect x="6" y="5" width="4" height="14" />
        <rect x="14" y="5" width="4" height="14" />
      </svg>
    `;
    btn.style.backgroundColor = "#eee";
  } else {
    // أيقونة إرسال تشير لليسار ⬅️
    btn.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="white" style="transform: rotate(180deg);" xmlns="http://www.w3.org/2000/svg">
        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
      </svg>
    `;
    btn.style.backgroundColor = "var(--send-bg)";
  }
}



    let typingInterval = null;

    let latitude = null;
    let longitude = null;

    function fillSuggestion(text) {
      input.value = text;
      sendMessage();
    }
    const allSuggestions = [
    "ما هي الوثائق المطلوبة لحفر بئر؟",
    "كيف أقدم طلب دعم للمشروع الفلاحي؟",
    "كيف أطلب شهادة الاستغلال الفلاحي؟",
    "ما هي أنواع الدعم الفلاحي المتاحة؟",
    "هل أحتاج إلى رخصة لحفر ساقية؟",
    "ما هي الشروط للاستفادة من المخطط الأخضر؟"
];

 function handleSuggestionClick(button) {
   const text = button.textContent;
   input.value = text;
   sendMessage();

   const currentSuggestions = Array.from(document.querySelectorAll(".suggestions button"))
                                  .map(btn => btn.textContent);

   const alternatives = allSuggestions.filter(
    s => !currentSuggestions.includes(s) && s !== text
   );

   if (alternatives.length > 0) {
    const newSuggestion = alternatives[Math.floor(Math.random() * alternatives.length)];
    button.textContent = newSuggestion;
  }
}


    window.onload = function () {
      if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark");
        document.querySelector(".toggle-btn").textContent = "☀️";
      }

      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            latitude = position.coords.latitude;
            longitude = position.coords.longitude;
          },
          (error) => {
            console.warn("⚠️ فشل تحديد الموقع:", error.message);
          }
        );
      }
    };
    

    function addMessage(text, sender) {
  const messageWrapper = document.createElement("div");
  messageWrapper.className = "message " + sender;

  if (sender === "user") {
    messageWrapper.innerHTML = `
      <span class="msg-text">${text}</span>
      <button class="edit-btn" onclick="editMessage(this)" title="تعديل الرسالة">🖉</button>
    `;
    chatbox.appendChild(messageWrapper);
    chatbox.scrollTop = chatbox.scrollHeight;

  } else if (sender === "bot") {
    let i = 0;
    isBotTyping = true;
    updateSendButton("stop");

    const span = document.createElement("span");
    messageWrapper.appendChild(span);
    chatbox.appendChild(messageWrapper);

    typingInterval = setInterval(() => {
      span.innerText = text.slice(0, i);
      i++;
      if (i > text.length) {
        clearInterval(typingInterval);
        isBotTyping = false;
        updateSendButton("send");
      }
      chatbox.scrollTop = chatbox.scrollHeight;
    }, 20);
  }
}


  chatbox.appendChild(messageWrapper);
  chatbox.scrollTop = chatbox.scrollHeight;


function stopTyping() {
  if (typingInterval) {
    clearInterval(typingInterval);
    typingInterval = null;
    isBotTyping = false;
    updateSendButton("send");
    }
}


    function scrollToBottom() {
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    chatbox.addEventListener("scroll", () => {
      const nearBottom = chatbox.scrollTop + chatbox.clientHeight >= chatbox.scrollHeight - 100;
      scrollBtn.style.display = nearBottom ? "none" : "block";
    });

    async function sendMessage() {
      const userText = input.value.trim();
      if (!userText) return;

      addMessage(userText, "user");
      input.value = "";
      typing.style.display = "block";

      try {
        const res = await fetch("https://chatbot-agri-production.up.railway.app/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({
            message: userText,
            location: { latitude, longitude }
          })
        });

        const data = await res.json();
        typing.style.display = "none";
        addMessage(data.response, "bot");
  

      } catch (err) {
        typing.style.display = "none";
        addMessage("⚠️ حدث خطأ أثناء الاتصال بالخادم.", "bot");
      }
    }

    input.addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        event.preventDefault();
        sendMessage();
      }
    });

    function toggleDarkMode() {
      document.body.classList.toggle("dark");
      const btn = document.querySelector(".toggle-btn");
      btn.textContent = document.body.classList.contains("dark") ? "☀️" : "🌙";
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    }

    function startSpeech() {
      if (!('webkitSpeechRecognition' in window)) {
        alert("🎤 المتصفح لا يدعم خاصية الصوت.");
        return;
      }
      const recognition = new webkitSpeechRecognition();
      recognition.lang = 'ar-MA';
      recognition.onresult = function (event) {
        const transcript = event.results[0][0].transcript;
        if (transcript.includes("بير") || transcript.includes("بئر")) {
          input.value = "ما هي الوثائق المطلوبة لحفر بئر؟";
        } else if (transcript.includes("مشروع") || transcript.includes("استثمار")) {
          input.value = "كيف أطلب ترخيص لمشروع فلاحي؟";
        } else {
          input.value = transcript;
        }
        sendMessage();
      };
      recognition.start();
    }

    async function resetConversation() {
  await fetch("https://chatbot-agri-production.up.railway.app/reset", {
    method: "POST",
    credentials: "include"
  });

  chatbox.innerHTML = "";
  typing.style.display = "none";
  input.value = "";
  updateSendButton("send");
  document.getElementById("suggestions").style.display = "flex";

  if (typingInterval) {
   clearInterval(typingInterval);
   typingInterval = null;
   isBotTyping = false;
}


  </script>
</body>
</html>
